---
title: "Data Analysis for Early and Late Lung-colonizing Tumors"
author: "Emily Franz and Matt Cannon"
date: "`r format(Sys.time(), '%m/%d/%Y')`"
output:
    html_document:
    toc: true
    toc_float: true
    toc_depth: 5
    number_sections: false
    code_folding: hide
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    tidy = TRUE,
    echo = TRUE,
    cache = TRUE,
    collapse = TRUE,
    tidy.opts = list(width.cutoff = 95),
    message = FALSE,
    warning = FALSE,
    cache.lazy = FALSE
)
```

```{r lib}
# Load packages
library(Seurat)
library(tidyverse)
library(rrrSingleCellUtils)

# Set random generator seed to facilitate reproducibility
set.seed(888)
```

## Make up directory structure
```{bash mkdirs, eval=TRUE}
for directoryName in \
  output \
  output/figures \
  output/sobjs
do
  if [ ! -d ${directoryName} ]
  then
    mkdir ${directoryName}
  fi
done
```

# Load and Process Datasets
Datasets are from tumors collected from mouse lungs at early (day 14 post injection of tumor cells) and late (day 35 post injection of tumor cells) timepoints. mCherry was used to label the tumor cells as well as the surrounding niche cells.

```{r load}
sample_list <- read_tsv("misc/sample_cutoffs.txt")

sobj_list <- list()

for (i in seq_len(nrow(sample_list))) {
    species_pattern <- sample_list$species_pattern[i]

    dataset <-
        tenx_load_qc(paste0("/home/gdrobertslab/lab/Counts/",
                            sample_list$sample_name[i],
                            "/filtered_feature_bc_matrix"),
                     violin_plot = FALSE,
                     species_pattern = species_pattern)

    # Add metadata to dataset
    for (colname in colnames(metadata)) {
        dataset[[colname]] <- sample_list[[colname]][i]
    }

    dataset <- dataset %>%
        subset(nFeature_RNA >= sample_list$nfeature_rna_min[i] &
               nFeature_RNA <= sample_list$nfeature_rna_max[i] &
               nCount_RNA   >= sample_list$ncount_rna_min[i] &
               nCount_RNA   <= sample_list$ncount_rna_max[i] &
               percent.mt   <= sample_list$mt_max[i]) %>%
        process_seurat()

    FeaturePlot(dataset, features = "nFeature_RNA")
    plotted <- feature_hist(dataset) %>%
        add_lines()

    ggsave(paste0("output/figures/feature_hist_",
                  sample_list$obj_name[i],
                  "_filtered.png"),
           width = 10,
           height = 10,
           plot = plotted)

    assign(sample_list[i, "obj_name"] %>% unlist(), dataset)
    save(list = sample_list[["obj_name"]][i],
         file = paste0("output/rdata/",
                       sample_list$obj_name[i],
                       ".rds"))
}























#### D14 ####
# Load mCherry+ cells (tumor and surrounding microenvironment cells) from lungs collected on day 14
d14_positive <- tenx_load_qc("/gpfs0/home2/gdrobertslab/lab/Counts/S0082/filtered_feature_bc_matrix",
                             species_pattern = "^hg19_")

# Subset for QC
d14_positive <- subset(d14_positive,
                       subset = nCount_RNA > 800 &
                         nCount_RNA < 11000 &
                         percent.mt < 20)

## Add labels to metadata
d14_positive$timepoint <- "Day 14"
d14_positive$group <- "Early"
d14_positive$selection <- "mCherry+"

#### D35 ####
# Load mCherry+ cells (tumor and surrounding microenvironment cells) from lungs collected on day 35
d35_positive <- tenx_load_qc("/gpfs0/home2/gdrobertslab/lab/Counts/S0084/filtered_feature_bc_matrix",
                             species_pattern = "^hg19_")

## Add labels to metadata
d35_positive$timepoint <- "Day 35"
d35_positive$group <- "Late"
d35_positive$selection <- "mCherry+"

#Subset for QC
d35_positive <- subset(d35_positive,
                       subset = nCount_RNA > 800 &
                         nCount_RNA < 40000 &
                         percent.mt < 20)

#### Mouse ####
#### D14 ####
# Load mCherry+ cells (tumor and surrounding microenvironment cells) from lungs collected on day 14
md14_positive <- tenx_load_qc("/gpfs0/home2/gdrobertslab/lab/Counts/S0082/filtered_feature_bc_matrix",
                              species_pattern = "^mm10_")

# Subset for QC
md14_positive <- subset(md14_positive,
                        subset = nCount_RNA > 800 &
                          nCount_RNA < 7000 &
                          percent.mt < 20)

## Add labels to metadata
md14_positive$timepoint <- "Day 14"
md14_positive$group <- "Early"
md14_positive$selection <- "mCherry+"

#### D35 ####
# Load mCherry+ cells (tumor and surrounding microenvironment cells) from lungs collected on day 30
md35_positive <- tenx_load_qc("/gpfs0/home2/gdrobertslab/lab/Counts/S0084/filtered_feature_bc_matrix",
                              species_pattern = "^mm10_")

## Add labels to metadata
md35_positive$timepoint <- "Day 35"
md35_positive$group <- "Late"
md35_positive$selection <- "mCherry+"

# Subset for QC
md35_positive <- subset(md35_positive,
                        subset = nCount_RNA > 800 &
                          nCount_RNA < 20000 &
                          percent.mt < 10)
```

## Load and Process Mouse and Human Cells Together

```{r all_load}
#### D14 ####
# Load mCherry+ cells (tumor and surrounding microenvironment cells) from lungs collected on day 14
d14_positive_all <- tenx_load_qc("/gpfs0/home2/gdrobertslab/lab/Counts/S0082/filtered_feature_bc_matrix",
                                 species_pattern = "^hg19_|^mm10")

# Subset for QC
d14_positive_all <- subset(d14_positive_all,
                           subset = nCount_RNA > 800 &
                             nCount_RNA < 10000 &
                             percent.mt < 20)

## Add labels to metadata
d14_positive_all$timepoint <- "Day 14"
d14_positive_all$group <- "Early"
d14_positive_all$selection <- "mCherry+"

#### D35 ####
# Load mCherry+ cells (tumor and surrounding microenvironment cells) from lungs collected on day 35
d35_positive_all <- tenx_load_qc("/gpfs0/home2/gdrobertslab/lab/Counts/S0084/filtered_feature_bc_matrix",
                                 species_pattern = "^hg19_|^mm10")

## Add labels to metadata
d35_positive_all$timepoint <- "Day 35"
d35_positive_all$group <- "Late"
d35_positive_all$selection <- "mCherry+"

#Subset for QC
d35_positive_all <- subset(d35_positive_all,
                           subset = nCount_RNA > 800 &
                             nCount_RNA < 40000 &
                             percent.mt < 20)

tumor_all <- merge(d14_positive_all, y = d35_positive_all,
                   add.cell.ids = c("d14", "d35"),
                   project = "Early vs Late OS Mets")

tumor_all <- NormalizeData(tumor_all) %>%
  ScaleData() %>%
  FindVariableFeatures()
tumor_all <- RunPCA(tumor_all, features = VariableFeatures(tumor_all)) %>%
  FindNeighbors(dims = 1:20) %>%
  FindClusters(resolution = 0.15) %>%
  RunUMAP(dims = 1:20)

# Save
save(tumor_all, file = "Data/early_late_tumor_allcelltypes.RData")

umap_all <- DimPlot(tumor_all,
                    reduction = "umap",
                    pt.size = 1,
                    label = T) +
  theme(aspect.ratio = 1)

pdf("Figures/early_late_umap_all.pdf",
    width = 5,
    height = 5)
umap_all
dev.off()

umap_timepoint_all <- DimPlot(tumor_all,
                              reduction = "umap",
                              pt.size = 1,
                              label = T,
                              split.by = "timepoint") +
  theme(aspect.ratio = 1)

pdf("Figures/early_late_umap_timepoint_all.pdf",
    width = 5,
    height = 5)
umap_timepoint_all
dev.off()
```

## Human Cell Only Processing

```{r human-processing, dependson="load"}
# Human
# Merge day 14 and day 35 Seurat objects together 
tumor <- merge(d14_positive, y = d35_positive,
               add.cell.ids = c("d14", "d35"),
               project = "Early vs Late OS Mets")

# Process merged object
tumor <- NormalizeData(tumor) %>%
  ScaleData() %>%
  FindVariableFeatures()
tumor <- RunPCA(tumor,
                features = VariableFeatures(tumor)) %>%
  FindNeighbors(dims = 1:20) %>%
  FindClusters(resolution = 0.15) %>%
  RunUMAP(dims = 1:20)

# Plot UMAP
DimPlot(tumor,
        reduction = "umap",
        pt.size = 1,
        label = T) +
  theme(aspect.ratio = 1)

# Save human mCherry+ merged object
save(tumor, file = "Data/early_late_tumor.RData")

# Use timepoint naming (Day 14/Day 35) for UMAP plotting
umap_timepoint <- DimPlot(tumor,
                          reduction = "umap",
                          pt.size = 1,
                          group.by = "timepoint",
                          label = T) +
  theme(aspect.ratio = 1)
umap_timepoint

pdf("Figures/early_late_umap.pdf",
    width = 5,
    height = 5)
umap_timepoint
dev.off()

# Use basic naming (early/late) for UMAP plotting
umap_group <- DimPlot(tumor,
                      reduction = "umap",
                      pt.size = 1,
                      group.by = "group",
                      label = T) +
  theme(aspect.ratio = 1)
umap_group

pdf("Figures/early_late_umap.pdf",
    width = 5,
    height = 5)
umap_group
dev.off()
```

## Mouse Cell Only Processing

```{r mouse-processing, dependson="load"}
# Mouse
# Merge day 14 and day 35 Seurat objects together 
microenv <- merge(md14_positive, y = md35_positive,
                  add.cell.ids = c("d14", "d35"),
                  project = "Early vs Late OS Mets")

# Process merged object
microenv <- NormalizeData(microenv) %>%
  ScaleData() %>%
  FindVariableFeatures()
microenv <- RunPCA(microenv, features = VariableFeatures(microenv)) %>%
  FindNeighbors(dims = 1:20) %>%
  FindClusters(resolution = 0.15) %>%
  RunUMAP(dims = 1:20)

# Plot UMAP
DimPlot(microenv,
        reduction = "umap",
        pt.size = 1, label = T) +
  coord_fixed()

DimPlot(microenv,
        reduction = "umap",
        pt.size = 1,
        label = T,
        split.by = "group") +
  coord_fixed()

# Save mouse mCherry+ merged Seurat object
save(microenv, file = "Data/early_late_microenv.RData")
```

# Plotting Expression: Genes of Interest

## Human Cells Only: Pre-cell cycle regression

```{r human_geneplots, dependson=c("load","human-processing")}
# Dot plot of expression of genes of interest by group (early/late)
dot_plot <- DotPlot(tumor,
                    features = c("BCL2", 
                                 "BCL2L1",
                                 "BCL2L2",
                                 "MCL1"),
                    group.by = "group",
                    scale = F,
                    cols = "Spectral") +
  RotatedAxis()

# Save as pdf
pdf("Figures/early_late_dot_plot.pdf",
    width = 7,
    height = 4)
dot_plot +
  coord_fixed() 
dev.off()

# Violin plot of expression of genes of interest by group (early/late)
vln_plot <- VlnPlot(tumor,
                    features = c("BCL2", 
                                 "BCL2L1",
                                 "BCL2L2",
                                 "MCL1"),
                    group.by = "group") +
  RotatedAxis()

# Save as pdf
pdf("Figures/early_late_vln_plot.pdf",
    width = 6,
    height = 5)
vln_plot 
dev.off()

# Feature plot (UMAP) of expression of genes of interest by group (early/late)
feature_plot <- FeaturePlot(tumor,
                            features = c("BCL2", 
                                         "BCL2L1",
                                         "BCL2L2",
                                         "MCL1"),
                            split.by = "group",
                            order = T) +
  theme(aspect.ratio = 1)

# Save as pdf
pdf("Figures/early_late_feature_plot.pdf",
    width = 6,
    height = 12)
feature_plot 
dev.off()
```

## Human Cells Only: Post-cell cycle regression

Regress out cell cycle genes so that the dataset does not cluster on the UMAP 
by cell cycle gene expression.

```{r cc, dependson=c("load","human-processing")}
# Load Roberts lab package for kill_cc() function
library(rrrSingleCellUtils)

# Calculate cell cycle phase and view its effects on clustering
# Note: default for kill_cc() is not performing cell cycle regression
kill_cc(tumor)

# Save as pdf
pdf("Figures/early_late_tumor_pre-kill_cc.pdf",
    width = 5,
    height = 5)
kill_cc(tumor)
dev.off()

# Calculate cell cycle phase and remove its effects on clustering
tumor_cc <- kill_cc(tumor,
                    cc_regress = "Y")

# Rerun find neighbors/clusters to reinstate previous settings w/o cell cycle
tumor_cc <- FindNeighbors(tumor_cc, dims = 1:20) %>%
  FindClusters(resolution = 0.15) %>%
  RunUMAP(dims = 1:20)

# Plot tumor UMAP after cell cycle genes are regressed out
kill_cc(tumor_cc)

# Save as pdf
pdf("Figures/early_late_post-kill_cc.pdf",
    width = 5,
    height = 5)
kill_cc(tumor_cc)
dev.off()

# Plot tumor UMAP by timepoint post cell cycle regression
umap_cc <- DimPlot(tumor_cc,
                   reduction = "umap",
                   pt.size = 1,
                   label = T,
                   group.by = "timepoint") +
  theme(aspect.ratio = 1)
umap_cc

# Save as pdf
pdf("Figures/early_late_umap_cc_bytrtment.pdf",
    width = 5,
    height = 5)
umap_cc
dev.off()

# Save the cell cycle regressed tumor object
save(tumor_cc, file = "Data/early_late_tumor_cc.RData")
```

Repeat plots of gene expression post cell cycle regression.

```{r human_geneplots_postcc, dependson=c("load","human-processing","cc")}
# Dot plot of expression of genes of interest by group (early/late)
dot_plot <- DotPlot(tumor_cc,
                    features = c("BCL2", 
                                 "BCL2L1",
                                 "BCL2L2",
                                 "MCL1"),
                    group.by = "group",
                    scale = F,
                    cols = "Spectral") +
  RotatedAxis()

# Save as pdf
pdf("Figures/early_late_dot_plot_postccr.pdf",
    width = 7,
    height = 4)
dot_plot +
  coord_fixed() 
dev.off()

# Violin plot of expression of genes of interest by group (early/late)
vln_plot <- VlnPlot(tumor_cc,
                    features = c("BCL2", 
                                 "BCL2L1",
                                 "BCL2L2",
                                 "MCL1"),
                    group.by = "group") +
  RotatedAxis()

# Save as pdf
pdf("Figures/early_late_vln_plot_postccr.pdf",
    width = 6,
    height = 5)
vln_plot 
dev.off()

# Feature plot (UMAP) of expression of genes of interest by group (early/late)
feature_plot <- FeaturePlot(tumor_cc,
                            features = c("BCL2", 
                                         "BCL2L1",
                                         "BCL2L2",
                                         "MCL1"),
                            split.by = "group",
                            order = T) +
  theme(aspect.ratio = 1)

# Save as pdf
pdf("Figures/early_late_feature_plot_postccr.pdf",
    width = 6,
    height = 12)
feature_plot 
dev.off()
```


```{r, cache=FALSE}
sessionInfo()
```

